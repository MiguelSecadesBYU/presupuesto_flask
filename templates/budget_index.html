{% extends "base.html" %}
{% block title %}Presupuesto — Ciclo {{ d1.strftime('%d/%m/%Y') }} – {{ fin_inclusivo.strftime('%d/%m/%Y') }}{% endblock %}
{% block content %}
<h1>Presupuesto ({{ d1.strftime('%d/%m/%Y') }} – {{ fin_inclusivo.strftime('%d/%m/%Y') }})</h1>

<form class="form" method="post">
  <input type="hidden" name="y" value="{{ y }}">
  <input type="hidden" name="m" value="{{ m }}">

  <div class="card form-row">
    <div class="grow">
      <label>Ingreso estimado del ciclo (€)</label>
      <input type="number" step="0.01" name="income_estimated" value="{{ '%.2f'|format(income_estimated) }}">
    </div>
    <div class="row-end">
      <a class="btn" href="{{ url_for('budget_index', y=prev_y, m=prev_m) }}">← Ciclo anterior</a>
      <a class="btn" href="{{ url_for('budget_index', y=next_y, m=next_m) }}">Ciclo siguiente →</a>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Asignación por categoría (gasto)</div>
    <table class="table">
      <thead>
        <tr>
          <th>Categoría</th>
          <th class="right">Presupuesto (€)</th>
          <th class="right">Gastado (€)</th>
          <th class="right">Dif.</th>
        </tr>
      </thead>
      <tbody>
        {% for c in gasto_cats %}
          {% set presup = line_by_cat.get(c.id, 0.0) %}
          {% set gastado = spent_by_cat.get(c.id, 0.0) %}
          {% set diff = (presup|float) - (gastado|float) %}
          <tr>
            <td>{{ c.nombre }}</td>
            <td class="right">
              <input type="number" step="0.01" name="cat_{{ c.id }}" value="{{ '%.2f'|format(presup) }}" style="width:120px;text-align:right">
            </td>
            <td class="right">€ {{ '%.2f'|format(gastado) }}</td>
            <td class="right {{ 'pos' if diff>=0 else 'neg' }}">€ {{ '%.2f'|format(diff) }}</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th>Total</th>
          <th class="right">€ {{ '%.2f'|format(total_budget) }}</th>
          <th class="right">€ {{ '%.2f'|format(total_spent) }}</th>
          <th class="right {{ 'pos' if (total_budget-total_spent)>=0 else 'neg' }}">€ {{ '%.2f'|format(total_budget-total_spent) }}</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="card">
    <div class="card-title">Resumen</div>
    <table class="table">
      <tbody>
        <tr><td>Ingreso estimado</td><td class="right">€ {{ '%.2f'|format(income_estimated) }}</td></tr>
        <tr><td>Total presupuestado (gastos)</td><td class="right">€ {{ '%.2f'|format(total_budget) }}</td></tr>
        <tr>
          <td>“Libre” (ingreso estimado − presupuesto)</td>
          <td class="right {{ 'pos' if (income_estimated-total_budget)>=0 else 'neg' }}">€ {{ '%.2f'|format(income_estimated - total_budget) }}</td>
        </tr>
        <tr><td>Ingresos reales del ciclo (informativo)</td><td class="right">€ {{ '%.2f'|format(total_income_real) }}</td></tr>
      </tbody>
    </table>
  </div>

  <div class="row-end" style="margin-top:8px">
    <button class="btn primary">Guardar todo</button>
  </div>
</form>
{% endblock %}
