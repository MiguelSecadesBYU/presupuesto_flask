{% extends "base.html" %}
{% block title %}Resumen — Ciclo {{ d1.strftime('%d/%m/%Y') }} – {{ fin_inclusivo.strftime('%d/%m/%Y') }}{% endblock %}
{% block content %}
<h1>Ciclo {{ d1.strftime('%d/%m/%Y') }} – {{ fin_inclusivo.strftime('%d/%m/%Y') }}</h1>

<div class="grid">
  <div class="card"><div class="card-title">Ingresos</div><div class="kpi ok">€ {{ '%.2f'|format(ingresos) }}</div></div>
  <div class="card"><div class="card-title">Gastos</div><div class="kpi error">€ {{ '%.2f'|format(gastos) }}</div></div>
  <div class="card"><div class="card-title">Balance</div><div class="kpi {{ 'ok' if balance>=0 else 'error' }}">€ {{ '%.2f'|format(balance) }}</div></div>
</div>

<div class="row-between mb">
  <div>
    <a class="btn" href="{{ url_for('resumen', y=prev_y, m=prev_m) }}">← Ciclo anterior</a>
    <a class="btn" href="{{ url_for('resumen', y=next_y, m=next_m) }}">Ciclo siguiente →</a>
  </div>
  <a class="btn primary" href="{{ url_for('transactions_new') }}">+ Nueva transacción</a>
</div>

<div class="grid">
  <div class="card">
    <div class="card-title">Gasto por categoría (descendente)</div>
    <div style="height: 320px;">
      <canvas id="chartGastoCat"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Presupuesto vs Gastado (por categoría)</div>
    <div style="height: 320px;">
      <canvas id="chartBudgetVsSpent"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Ingresos vs Gastos (acumulado por día)</div>
    <div style="height: 320px;">
      <canvas id="chartIngVsGas"></canvas>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-title">Saldos por cuenta</div>
  <table class="table">
    <thead><tr><th>Cuenta</th><th class="right">Saldo</th></tr></thead>
    <tbody>
      {% for s in saldos %}
        <tr><td>{{ s.cuenta.nombre }}</td><td class="right"><strong>€ {{ '%.2f'|format(s.saldo) }}</strong></td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <div class="card-title">Totales del ciclo por categoría</div>
  <table class="table">
    <thead><tr><th>Categoría</th><th>Tipo</th><th class="right">Total</th></tr></thead>
    <tbody>
      {% for (nombre, tipo), total in por_cat.items() %}
        <tr>
          <td>{{ nombre }}</td>
          <td><span class="badge {{ 'ing' if tipo=='ingreso' else 'gas' }}">{{ tipo }}</span></td>
          <td class="right">€ {{ '%.2f'|format(total) }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- Datos con fallback seguro ---
  const labelsExp   = {{ labels_exp  | default([]) | tojson }};
  const dataExp     = {{ data_exp    | default([]) | tojson }};
  const labelsBV    = {{ labels_bv   | default([]) | tojson }};
  const dataBudget  = {{ data_budget | default([]) | tojson }};
  const dataSpent   = {{ data_spent  | default([]) | tojson }};

  const labelsDays  = {{ labels_days      | default([]) | tojson }};
  const serieIng    = {{ series_ingresos  | default([]) | tojson }};
  const serieGas    = {{ series_gastos    | default([]) | tojson }};

  // Gasto por categoría
  const el1 = document.getElementById('chartGastoCat');
  if (el1 && labelsExp.length) {
    new Chart(el1.getContext('2d'), {
      type: 'bar',
      data: { labels: labelsExp, datasets: [{ label: 'Gasto (€)', data: dataExp }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  }

  // Presupuesto vs Gastado
  const el2 = document.getElementById('chartBudgetVsSpent');
  if (el2 && labelsBV.length) {
    new Chart(el2.getContext('2d'), {
      type: 'bar',
      data: { labels: labelsBV, datasets: [
        { label: 'Presupuestado', data: dataBudget },
        { label: 'Gastado',       data: dataSpent }
      ]},
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });
  }

  // Ingresos vs Gastos acumulados (línea)
  const el3 = document.getElementById('chartIngVsGas');
  if (el3 && labelsDays.length && (serieIng.length || serieGas.length)) {
    new Chart(el3.getContext('2d'), {
      type: 'line',
      data: {
        labels: labelsDays,
        datasets: [
          { label: 'Ingresos acumulados', data: serieIng, tension: 0.3, fill: false },
          { label: 'Gastos acumulados',   data: serieGas, tension: 0.3, fill: false }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
</script>
{% endblock %}
