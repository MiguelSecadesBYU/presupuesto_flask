{% extends "base.html" %}
{% block title %}Resumen — Ciclo {{ d1.strftime('%d/%m/%Y') }} – {{ fin_inclusivo.strftime('%d/%m/%Y') }}{% endblock %}
{% block content %}
<h1>Ciclo {{ d1.strftime('%d/%m/%Y') }} – {{ fin_inclusivo.strftime('%d/%m/%Y') }}</h1>

<div class="grid">
  <div class="card"><div class="card-title">Ingresos</div><div class="kpi ok">€ {{ '%.2f'|format(ingresos) }}</div></div>
  <div class="card"><div class="card-title">Gastos</div><div class="kpi error">€ {{ '%.2f'|format(gastos) }}</div></div>
  <div class="card"><div class="card-title">Balance</div><div class="kpi {{ 'ok' if balance>=0 else 'error' }}">€ {{ '%.2f'|format(balance) }}</div></div>
</div>

<div class="row-between mb">
  <div>
    <a class="btn" href="{{ url_for('resumen', y=prev_y, m=prev_m) }}">← Ciclo anterior</a>
    <a class="btn" href="{{ url_for('resumen', y=next_y, m=next_m) }}">Ciclo siguiente →</a>
  </div>
  <a class="btn primary" href="{{ url_for('transactions_new') }}">+ Nueva transacción</a>
</div>

<div class="grid">
  <div class="card">
    <div class="card-title">Gasto por categoría (descendente)</div>
    <canvas id="chartGastoCat"></canvas>
  </div>

  <div class="card">
    <div class="card-title">Presupuesto vs Gastado (por categoría)</div>
    <canvas id="chartBudgetVsSpent"></canvas>
  </div>

  <div class="card">
    <div class="card-title">Ingresos vs Gastos (acumulado por día)</div>
    <canvas id="chartIngVsGas"></canvas>
  </div>
</div>

<div class="card">
  <div class="card-title">Saldos por cuenta</div>
  <table class="table">
    <thead><tr><th>Cuenta</th><th class="right">Saldo</th></tr></thead>
    <tbody>
      {% for s in saldos %}
        <tr><td>{{ s.cuenta.nombre }}</td><td class="right"><strong>€ {{ '%.2f'|format(s.saldo) }}</strong></td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
/* Datos para Chart 1 */
const labelsCat = {{ labels_cat_desc | default([]) | tojson }};
const valuesCat = {{ values_cat_desc | default([]) | tojson }};

/* Datos para Chart 2 */
const labelsBV   = {{ labels_bv   | default([]) | tojson }};
const dataBudget = {{ data_budget | default([]) | tojson }};
const dataSpent  = {{ data_spent  | default([]) | tojson }};

/* Datos para Chart 3 (acumulado) */
const labelsDays = {{ labels_days      | default([]) | tojson }};
const ingAcum    = {{ series_ingresos  | default([]) | tojson }};
const gasAcum    = {{ series_gastos    | default([]) | tojson }};

/* Chart 1: Gasto por categoría */
new Chart(document.getElementById('chartGastoCat'), {
  type: 'bar',
  data: { labels: labelsCat, datasets: [{ label: 'Gasto', data: valuesCat }] },
  options: {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: { y: { beginAtZero: true } }
  }
});

/* Chart 2: Presupuesto vs Gastado */
new Chart(document.getElementById('chartBudgetVsSpent'), {
  type: 'bar',
  data: {
    labels: labelsBV,
    datasets: [
      { label: 'Presupuestado', data: dataBudget },
      { label: 'Gasto',         data: dataSpent  }
    ]
  },
  options: {
    responsive: true,
    scales: { y: { beginAtZero: true } }
  }
});

/* Chart 3: Ingresos vs Gastos (acumulado) */
new Chart(document.getElementById('chartIngVsGas'), {
  type: 'line',
  data: {
    labels: labelsDays,
    datasets: [
      { label: 'Ingresos acumulados', data: ingAcum, borderWidth: 2, tension: 0.3 },
      { label: 'Gastos acumulados',   data: gasAcum, borderWidth: 2, tension: 0.3 }
    ]
  },
  options: {
    responsive: true,
    interaction: { mode: 'index', intersect: false },
    scales: { y: { beginAtZero: true } }
  }
});
</script>
{% endblock %}
